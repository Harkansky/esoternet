{% extends 'base.html.twig' %}

{% block title %}Paiement avec Stripe{% endblock %}

{% block body %}
    <div class="container mx-auto p-8">
        <div class="max-w-lg mx-auto bg-white p-6 rounded-lg shadow-lg">
            <h1 class="text-2xl font-semibold text-center mb-6">Payer avec Stripe</h1>

            <!-- Formulaire de paiement Stripe -->
            <form id="payment-form">
                <div id="card-element" class="mb-4">
                    <!-- Un élément de carte Stripe sera inséré ici. -->
                </div>

                <!-- Afficher des erreurs, si elles existent -->
                <div id="card-errors" role="alert"></div>

                <button type="submit" class="btn btn-primary w-full mt-4">
                    Payer
                </button>
            </form>
        </div>
    </div>

    <script src="https://js.stripe.com/v3/"></script>

    <script>
        // Clé publique Stripe (injected from Symfony controller)
        var stripe = Stripe('{{ stripe_public_key }}'); // Utilise la clé publique définie dans .env
        var elements = stripe.elements();

        // Création de l'élément carte
        var card = elements.create('card');
        card.mount('#card-element');

        // Soumettre le formulaire et obtenir le client secret
        var form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();

            // Créer un paiement intent côté serveur (via ton Symfony controller)
            fetch('/create-payment-intent', {
                method: 'POST',
            })
                .then(function(response) {
                    return response.json();
                })
                .then(function(paymentData) {
                    var clientSecret = paymentData.clientSecret;

                    // Utilisation de Stripe.js pour confirmer le paiement
                    stripe.confirmCardPayment(clientSecret, {
                        payment_method: {
                            card: card,
                        },
                    })
                        .then(function(result) {
                            if (result.error) {
                                // Afficher l'erreur à l'utilisateur
                                var errorElement = document.getElementById('card-errors');
                                errorElement.textContent = result.error.message;
                            } else {
                                if (result.paymentIntent.status === 'succeeded') {
                                    alert('Paiement réussi !');
                                }
                            }
                        });
                });
        });
    </script>
{% endblock %}
